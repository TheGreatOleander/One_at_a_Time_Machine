{"url":"https://api.github.com/repos/vercel/next.js/issues/81063","repository_url":"https://api.github.com/repos/vercel/next.js","labels_url":"https://api.github.com/repos/vercel/next.js/issues/81063/labels{/name}","comments_url":"https://api.github.com/repos/vercel/next.js/issues/81063/comments","events_url":"https://api.github.com/repos/vercel/next.js/issues/81063/events","html_url":"https://github.com/vercel/next.js/issues/81063","id":3187877647,"node_id":"I_kwDOBC3Cis6-AycP","number":81063,"title":"Diagnostics channel from node leak into edge environment in dev","user":{"login":"mydea","id":2411343,"node_id":"MDQ6VXNlcjI0MTEzNDM=","avatar_url":"https://avatars.githubusercontent.com/u/2411343?v=4","gravatar_id":"","url":"https://api.github.com/users/mydea","html_url":"https://github.com/mydea","followers_url":"https://api.github.com/users/mydea/followers","following_url":"https://api.github.com/users/mydea/following{/other_user}","gists_url":"https://api.github.com/users/mydea/gists{/gist_id}","starred_url":"https://api.github.com/users/mydea/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mydea/subscriptions","organizations_url":"https://api.github.com/users/mydea/orgs","repos_url":"https://api.github.com/users/mydea/repos","events_url":"https://api.github.com/users/mydea/events{/privacy}","received_events_url":"https://api.github.com/users/mydea/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":6834839951,"node_id":"LA_kwDOBC3Cis8AAAABl2Nhjw","url":"https://api.github.com/repos/vercel/next.js/labels/Instrumentation","name":"Instrumentation","color":"fef2c0","default":false,"description":"Related to Next.js Instrumentation."}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-06-30T09:57:11Z","updated_at":"2025-07-02T04:27:00Z","closed_at":null,"author_association":"NONE","type":{"id":1930995,"node_id":"IT_kwDOAOSnPM4AHXbz","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T15:36:35Z","updated_at":"2024-07-26T10:33:22Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"body":"### Link to the code that reproduces this issue\n\nhttps://codesandbox.io/p/devbox/happy-mclean-htz6qx\n\n### To Reproduce\n\n1. Start the application (`next dev`)\n2. Click on the button to trigger the edge API route\n3. See the console.log `finished fetch node request to: https://github.com` \n\n### Current vs. Expected behavior\n\nThe problem seems to be as follows:\n\n* Register a diagnostics channel subscription, which is a node-only API, in the `register` hook of `instrumentation.ts`. \n* Then, if you trigger fetch in an edge route, where diagnostics channel should not even be a thing, observe that it is still triggering the diagnostics channel (in the node env)\n\nIt seems that the simulated edge environment (?) in dev does not properly isolate the fetch diagnostics channel. This should not happen and leads to hard-to-debug problems with observability, where fetch requests from edge requests weirdly trigger code in the node environment.\n\n### Provide environment information\n\n```bash\nOperating System:\n  Platform: linux\n  Arch: x64\n  Version: #1 SMP PREEMPT_DYNAMIC Sun Aug  6 20:05:33 UTC 2023\n  Available memory (MB): 4102\n  Available CPU cores: 2\nBinaries:\n  Node: 20.9.0\n  npm: 9.8.1\n  Yarn: 1.22.19\n  pnpm: 8.10.2\nRelevant Packages:\n  next: 15.4.0-canary.103 // Latest available version is detected (15.4.0-canary.103).\n  eslint-config-next: N/A\n  react: 19.1.0\n  react-dom: 19.1.0\n  typescript: 5.3.3\nNext.js Config:\n  output: N/A\n```\n\n### Which area(s) are affected? (Select all that apply)\n\nInstrumentation\n\n### Which stage(s) are affected? (Select all that apply)\n\nnext dev (local)\n\n### Additional context\n\n_No response_","reactions":{"url":"https://api.github.com/repos/vercel/next.js/issues/81063/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vercel/next.js/issues/81063/timeline","performed_via_github_app":null,"state_reason":null,"score":1.0}
